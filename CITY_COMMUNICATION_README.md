# 城市通讯功能使用说明

## 功能概述

城市通讯功能允许用户模拟城市拓扑中的一个节点，与其他城市进行实时通讯。

## 功能特性

1. **城市身份选择**：用户可以选择自己的城市身份（如北京、上海等）
2. **实时聊天**：支持与其他城市进行实时消息交流
3. **系统通知**：显示城市加入/离开通讯网络的通知
4. **数据同步**：自动从城市地图叠加页面获取城市数据

## 使用方法

### 1. 启动服务

#### 启动后端服务

```bash
# 方法1：使用批处理文件（Windows）
start_backend.bat

# 方法2：手动启动
cd backend
pip install -r requirements.txt
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

#### 启动前端服务

```bash
# 方法1：使用批处理文件（Windows）
start_frontend.bat

# 方法2：手动启动
cd frontend
npm install
npm run dev
```

### 2. 使用城市通讯功能

1. **准备城市数据**：
   
   - 首先访问"城市地图叠加"页面
   - 上传包含城市信息的CSV文件
   - 城市数据会自动保存到本地存储

2. **进入城市通讯**：
   
   - 点击侧边栏的"城市通讯"选项
   - 系统会自动加载可用的城市列表

3. **选择城市身份**：
   
   - 从城市列表中选择您要模拟的城市
   - 系统会建立WebSocket连接

4. **开始通讯**：
   
   - 在聊天界面中输入消息
   - 按回车键或点击"发送"按钮发送消息
   - 接收其他城市发送的消息

## 技术实现

### 前端技术

- **Vue 3**：使用Composition API
- **WebSocket**：实现实时通讯
- **LocalStorage**：存储城市数据
- **响应式设计**：支持移动端和桌面端

### 后端技术

- **FastAPI**：Web框架
- **WebSocket**：实时通讯协议
- **CORS**：跨域资源共享
- **连接管理**：管理多个城市连接

### 数据流程

1. 用户在"城市地图叠加"页面上传CSV文件
2. 城市数据保存到localStorage
3. "城市通讯"页面从localStorage读取城市数据
4. 用户选择城市身份，建立WebSocket连接
5. 消息通过WebSocket在服务器端广播
6. 所有连接的客户端接收消息

## API接口

### WebSocket接口

- **连接**：`ws://localhost:8000/ws/{city}`

- **消息格式**：
  
  ```json
  {
    "type": "message",
    "from": "城市名",
    "message": "消息内容",
    "timestamp": "时间戳"
  }
  ```

### HTTP接口

- **健康检查**：`GET /health`
- **获取城市列表**：`GET /cities`

## 注意事项

1. **数据依赖**：使用城市通讯功能前，请先在"城市地图叠加"页面加载城市数据
2. **网络连接**：确保前后端服务都正常运行
3. **浏览器兼容性**：建议使用现代浏览器（Chrome、Firefox、Safari、Edge）
4. **多用户测试**：可以打开多个浏览器标签页模拟不同城市

## 故障排除

### 常见问题

1. **无法连接WebSocket**：
   
   - 检查后端服务是否启动
   - 确认端口8000未被占用
   - 检查防火墙设置

2. **城市列表为空**：
   
   - 确保已在"城市地图叠加"页面加载城市数据
   - 检查浏览器localStorage是否被清除

3. **消息发送失败**：
   
   - 检查WebSocket连接状态
   - 确认网络连接正常

### 调试方法

1. **浏览器开发者工具**：
   
   - 查看Console面板的错误信息
   - 检查Network面板的WebSocket连接状态

2. **后端日志**：
   
   - 查看终端输出的服务器日志
   - 检查连接和消息处理情况

## 扩展功能

未来可以考虑添加的功能：

1. **私聊功能**：支持城市之间的私聊
2. **消息历史**：保存聊天记录
3. **文件传输**：支持发送文件
4. **用户状态**：显示在线/离线状态
5. **消息加密**：增强安全性
